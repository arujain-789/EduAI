<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PDF Grader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --danger: #e74a3b;
        }
        body {
            background-color: #f8f9fc;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .upload-container {
            max-width: 600px;
            margin: 2rem auto;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .card-header {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        #dropZone {
            border: 2px dashed #dddfeb;
            border-radius: 5px;
            transition: all 0.3s;
        }
        #dropZone.dragover {
            border-color: var(--primary);
            background-color: rgba(78, 115, 223, 0.05);
        }
        .progress {
            height: 0.5rem;
        }
        .file-list-item:hover {
            background-color: #f8f9fa;
        }
        #feedbackContainer {
            transition: all 0.3s ease;
        }
        .status-badge {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="upload-container card">
            <div class="card-header py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="bi bi-cloud-arrow-up me-2"></i>PDF Grading System</h5>
                    <span class="badge status-badge bg-light text-primary" id="statusBadge">Ready</span>
                </div>
            </div>
            
            <div class="card-body">
                <!-- File Drop Zone -->
                <div id="dropZone" class="p-4 text-center mb-4">
                    <i class="bi bi-file-earmark-pdf display-4 text-muted mb-3"></i>
                    <h5>Drag & Drop PDF Here</h5>
                    <p class="text-muted mb-3">or</p>
                    <input type="file" id="fileInput" accept=".pdf" class="d-none">
                    <button class="btn btn-primary" id="browseBtn">
                        <i class="bi bi-folder2-open me-2"></i>Browse Files
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="mb-3 d-none" id="progressContainer">
                    <div class="d-flex justify-content-between mb-1">
                        <small>Uploading...</small>
                        <small><span id="progressPercent">0</span>%</small>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results" class="d-none">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0"><i class="bi bi-robot me-2"></i>AI Feedback</h5>
                        <a href="#" id="pdfLink" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye me-1"></i>View PDF
                        </a>
                    </div>
                    
                    <div class="alert alert-success">
                        <div class="d-flex">
                            <i class="bi bi-check-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Marks: <span id="marks">-</span>/100</strong>
                                <div id="feedback" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Uploaded Files -->
                <div id="fileListContainer" class="mt-4">
                    <h6><i class="bi bi-files me-2"></i>Previously Graded</h6>
                    <div class="list-group" id="fileList">
                        <div class="text-center py-3 text-muted" id="emptyState">
                            <i class="bi bi-inbox display-6"></i>
                            <p class="mt-2">No graded assignments yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Configuration
    const SERVER_URL = "http://localhost:3000"; // Ensure backend URL is correct
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const resultsDiv = document.getElementById('results');
    const fileList = document.getElementById('fileList');
    const emptyState = document.getElementById('emptyState');
    const statusBadge = document.getElementById('statusBadge');

    // Initialize
    loadFileList();

    // Event Listeners
    browseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    // Drag & Drop Listeners
    ['dragenter', 'dragover'].forEach(event => dropZone.addEventListener(event, highlight));
    ['dragleave', 'drop'].forEach(event => dropZone.addEventListener(event, unhighlight));
    dropZone.addEventListener('drop', handleDrop);

    function highlight() {
        dropZone.classList.add('dragover');
        updateStatus("Drop PDF", "warning");
    }

    function unhighlight() {
        dropZone.classList.remove('dragover');
        updateStatus("Ready", "light");
    }

    function handleDrop(e) {
        e.preventDefault();
        if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    }

    function handleFileSelect() {
        if (fileInput.files.length) handleFiles(fileInput.files);
    }

    async function handleFiles(files) {
        const file = files[0];

        if (!file) return updateStatus("No file selected", "danger");
        if (file.type !== "application/pdf") return updateStatus("Only PDFs allowed", "danger");
        if (file.size > MAX_FILE_SIZE) return updateStatus("File too large (max 10MB)", "danger");

        updateStatus("Uploading...", "info");
        showProgress();

        const formData = new FormData();
        formData.append('pdf', file);

        try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `${SERVER_URL}/upload`, true);  // Open first
            xhr.setRequestHeader('Accept', 'application/json');  // Set headers before sending

            // Track progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    updateProgress(Math.round((e.loaded / e.total) * 100));
                }
            });

            xhr.onload = function () {
                hideProgress();
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        processSuccess(JSON.parse(xhr.responseText));
                    } catch (e) {
                        console.error("Response parsing error:", e);
                        updateStatus("Invalid server response", "danger");
                    }
                } else {
                    handleUploadError(xhr);
                }
            };

            xhr.onerror = function () {
                updateStatus("Network error", "danger");
                hideProgress();
            };

            xhr.send(formData); // Send after headers are set
        } catch (error) {
            console.error('Upload error:', error);
            updateStatus("Upload failed", "danger");
            hideProgress();
        }
    }

    function updateProgress(percent) {
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = percent;
        if (percent === 100) {
            progressBar.classList.remove('progress-bar-animated');
            updateStatus("Processing with AI...", "info");
        }
    }

    function showProgress() {
        progressContainer.classList.remove('d-none');
        resultsDiv.classList.add('d-none');
    }

    function hideProgress() {
        progressContainer.classList.add('d-none');
    }

    function updateStatus(text, type) {
        statusBadge.textContent = text;
        statusBadge.className = `badge status-badge bg-${type} ${type === 'light' ? 'text-primary' : 'text-white'}`;
    }

    function processSuccess(response) {
        updateStatus("Grading complete", "success");

        document.getElementById('marks').textContent = response.marks || "N/A";
        document.getElementById('feedback').textContent = response.feedback || "No feedback available.";
        document.getElementById('pdfLink').href = response.url || "#";
        resultsDiv.classList.remove('d-none');

        if (response.filename) {
            addFileToList(response.filename, response.url);
            loadFileList();
        }
    }

    function addFileToList(filename, url) {
        const files = JSON.parse(localStorage.getItem('gradedFiles')) || [];
        if (!files.some(file => file.name === filename)) {
            files.push({ name: filename, url, date: new Date().toISOString() });
            localStorage.setItem('gradedFiles', JSON.stringify(files));
        }
    }

    function loadFileList() {
        const files = JSON.parse(localStorage.getItem('gradedFiles')) || [];
        fileList.innerHTML = '';

        if (files.length) {
            emptyState.classList.add('d-none');
            files.forEach(file => {
                const listItem = document.createElement('a');
                listItem.href = file.url || "#";
                listItem.target = '_blank';
                listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
                    <div>
                        <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                        ${file.name}
                        <div class="text-muted small">${new Date(file.date).toLocaleString()}</div>
                    </div>
                    <i class="bi bi-box-arrow-up-right text-muted"></i>
                `;
                fileList.appendChild(listItem);
            });
        } else {
            emptyState.classList.remove('d-none');
        }
    }

    // ✅ Test backend connection
    fetch(`${SERVER_URL}/health`)
        .then(response => response.ok ? response.json() : Promise.reject('Backend offline'))
        .then(data => console.log('Backend connected:', data))
        .catch(error => {
            console.error("Connection test failed:", error);
            updateStatus("Backend unavailable", "danger");
        });
</script>

</body>
</html>
